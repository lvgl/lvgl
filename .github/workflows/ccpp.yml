name: C/C++ CI

on:
  push:
    branches: [ master, release/v8.* ]
  pull_request:
    branches: [ master, release/v8.* ]

# https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions#concurrency
# Ensure that only one commit will be running tests at a time on each PR
concurrency:
  group: ${{ github.ref }}-${{ github.workflow }} 
  cancel-in-progress: true

jobs:
  build-ubuntu:
    if: ${{ github.event_name != 'pull_request' || github.repository != github.event.pull_request.head.repo.full_name }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        # A valid option parameter to the cmake file.
        # See BUILD_OPTIONS in tests/CMakeLists.txt.
        build_option: ['OPTIONS_NORMAL_8BIT',
                       'OPTIONS_16BIT',
                       'OPTIONS_24BIT',
                       'OPTIONS_FULL_32BIT',
                       'OPTIONS_SDL']
    name: Build ${{ matrix.build_option }} - Ubuntu
    steps:
    - uses: actions/checkout@v6
    - uses: ammaraskar/gcc-problem-matcher@master
    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
    - name: Install prerequisites
      run: scripts/install-prerequisites.sh
    - name: Install pngquant
      run:  scripts/install_pngquant.sh
    - name: Verify the environment dependency installation
      run: scripts/run_tests.sh --skip-tests
    - name: Building ${{ matrix.build_option }}
      run: python tests/main.py --build-option=${{ matrix.build_option }} build --auto-clean

  build-windows:
    strategy:
      fail-fast: false
      matrix:
        # A valid option parameter to the cmake file.
        # See BUILD_OPTIONS in tests/CMakeLists.txt.
        build_option: ['OPTIONS_16BIT',
                       'OPTIONS_24BIT',
                       'OPTIONS_FULL_32BIT']
        compiler: [gcc, cl]

    name: Build ${{ matrix.build_option }} - ${{matrix.compiler }} - Windows
    runs-on: windows-2022
    steps:
    - name: patch freetype vcpkg URL
      run: (Get-Content C:\vcpkg\ports\freetype\portfile.cmake) -replace 'freedesktop.org', 'com' | Out-File -encoding ASCII C:\vcpkg\ports\freetype\portfile.cmake

    - uses: actions/checkout@v6

    - name: Install prerequisites
      run: scripts\install-prerequisites.bat

    - if: matrix.compiler == 'gcc'
      uses: ammaraskar/gcc-problem-matcher@master

    - if: matrix.compiler == 'cl'
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - if: matrix.compiler == 'cl'
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 'mswin'

    - name: Build
      run: python tests/main.py --build-option=${{ matrix.build_option }} build
      env:
        CC: ${{ matrix.compiler }}

  build-esp32s3:
    runs-on: ubuntu-24.04
    name: Build ESP IDF ESP32S3
    container: espressif/idf:v5.3.1
    steps:
    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
    - name: Clone LVGL as a Component
      uses: actions/checkout@v6
      with:
        path: components/lvgl
    - name: Copy IDF Project Example
      run: . /opt/esp/idf/export.sh && cp -r $IDF_PATH/examples/get-started/hello_world/* .
    - name: Set Target ESP32S3
      run: . /opt/esp/idf/export.sh && idf.py set-target esp32s3
    - name: Build
      run: . /opt/esp/idf/export.sh && idf.py build

  test-native:
    runs-on: ubuntu-24.04
    strategy:
     matrix:
       # A valid option parameter to the cmake file.
       # See BUILD_OPTIONS in tests/CMakeLists.txt.
       build_config: ['64bit build',
                      '32bit build']
    name: Run tests with ${{ matrix.build_config }}
    steps:
    - uses: actions/checkout@v6
    - uses: ammaraskar/gcc-problem-matcher@master
    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
    - name: Install prerequisites
      run: scripts/install-prerequisites.sh
    - name: Install pngquant
      run: scripts/install_pngquant.sh
    - name: Verify the environment dependency installation
      run: scripts/run_tests.sh --skip-tests
    - name: Fix kernel mmap rnd bits
      # Asan in llvm 14 provided in ubuntu 22.04 is incompatible with
      # high-entropy ASLR in much newer kernels that GitHub runners are
      # using leading to random crashes: https://reviews.llvm.org/D148280
      run: sudo sysctl vm.mmap_rnd_bits=28
    - name: Set environment variables for 32-bit build
      if: matrix.build_config == '32bit build'
      run: echo "NON_AMD64_BUILD=1" >> $GITHUB_ENV
    - name: Run tests
      run: python tests/main.py --report --update-image test --auto-clean --keep-report
    - name: Code coverage analysis
      id: coverage
      if: github.event_name == 'pull_request'
      run: |
        git fetch --no-tags --prune origin ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}
        MB=$(git merge-base ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        echo "Merge-base: $MB"
        COMMIT_RANGE="${MB}...${{ github.event.pull_request.head.sha }}"
        
        # Capture coverage output
        COVERAGE_OUTPUT=$(python scripts/check_gcov_coverage.py --commit="$COMMIT_RANGE" 2>&1) || true
        echo "$COVERAGE_OUTPUT"
        
        # Extract key metrics for the summary
        COVERAGE_PERCENT=$(echo "$COVERAGE_OUTPUT" | grep -oP 'Coverage: \K[\d.]+' || echo "N/A")
        COVERED_LINES=$(echo "$COVERAGE_OUTPUT" | grep -oP 'Covered lines: \K\d+' || echo "0")
        UNCOVERED_LINES=$(echo "$COVERAGE_OUTPUT" | grep -oP 'Uncovered lines: \K\d+' || echo "0")
        TOTAL_LINES=$(echo "$COVERAGE_OUTPUT" | grep -oP 'New coverable lines \(per gcovr\): \K\d+' || echo "0")
        
        echo "coverage_percent=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT
        echo "covered_lines=$COVERED_LINES" >> $GITHUB_OUTPUT
        echo "uncovered_lines=$UNCOVERED_LINES" >> $GITHUB_OUTPUT
        echo "total_lines=$TOTAL_LINES" >> $GITHUB_OUTPUT
        
        # Extract uncovered lines list (limit to first 30 lines to avoid huge comments)
        UNCOVERED_LIST=$(echo "$COVERAGE_OUTPUT" | grep -A 1000 "Uncovered lines" | tail -n +2 | head -30)
        UNCOVERED_COUNT=$(echo "$COVERAGE_OUTPUT" | grep -A 1000 "Uncovered lines" | tail -n +2 | wc -l)
        
        # Save uncovered lines separately
        {
          echo 'uncovered_list<<EOF'
          echo "$UNCOVERED_LIST"
          if [ "$UNCOVERED_COUNT" -gt 30 ]; then
            echo "  ... and $((UNCOVERED_COUNT - 30)) more uncovered lines"
          fi
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: Post coverage report to PR
      if: github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: coverage-${{ matrix.build_config }}
        message: |
          ## ðŸ“Š Code Coverage Report - ${{ matrix.build_config }}
          
          | Metric | Value |
          |--------|-------|
          | **Coverage** | ${{ steps.coverage.outputs.coverage_percent }}% |
          | **Covered Lines** | ${{ steps.coverage.outputs.covered_lines }} |
          | **Uncovered Lines** | ${{ steps.coverage.outputs.uncovered_lines }} |
          | **Total New Coverable Lines** | ${{ steps.coverage.outputs.total_lines }} |
          
          <details>
          <summary>ðŸ“‹ Uncovered Lines (max 30 shown)</summary>
          
          ```
          ${{ steps.coverage.outputs.uncovered_list }}
          ```
          
          </details>
          
          ---
          *Report generated for commit ${{ github.event.pull_request.head.sha }}*

    - name: Archive screenshot errors
      if: failure()
      uses: actions/upload-artifact@v6
      with:
        name: screenshot-errors-amd64
        path: |
             tests/ref_imgs*/**/*_err.png
             test_screenshot_error.h
    - id: check_untracked_ref_imgs
      name: Check for new files and upload them as artifacts if found
      run: |
        NEW_REF_IMGS=$(git status --porcelain -- tests/ref_imgs* | grep '^??' | awk '{print $2}')

        if [ -n "$NEW_REF_IMGS" ]; then
          echo "New files were added during the build process."
          echo "Uploading untracked ref. images as artifacts..."
          for file in $NEW_REF_IMGS; do
            echo "Found new file: $file"
          done
          zip -r untracked_ref_imgs.zip $NEW_REF_IMGS
          echo "::set-output name=new_ref_imgs_found::true"
        else
          echo "No new files were found."
          echo "::set-output name=new_ref_imgs_found::false"
        fi

    - name: Upload untracked reference images
      if: steps.check_untracked_ref_imgs.outputs.new_ref_imgs_found == 'true'
      uses: actions/upload-artifact@v6
      with:
        name: Untracked Reference Images
        path: untracked_ref_imgs.zip

    - name: Fail the build if new files were found
      if: steps.check_untracked_ref_imgs.outputs.new_ref_imgs_found == 'true'
      run: |
        echo "Failing the build due to newly generated reference images."
        exit 1

    - name: Upload coverage reports as artifacts
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: coverage-reports-${{ matrix.build_config }}
        path: tests/report/
